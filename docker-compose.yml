version: '3.9'
services:
  service-mariadb:
    image: mariadb:10.5
    restart: unless-stopped
    environment:
      - MARIADB_DATABASE=finance-transactions
      - MARIADB_ROOT_PASSWORD=mauFJcuf5dhRMQrjj
      - MARIADB_USER=transactions
      - MARIADB_PASSWORD=mauFJcuf5dhRMQrjj
    ports:
      - '3308:3306'
  service-redis:
    image: 'redis:alpine'
    ports:
      - '6379:6379'
    volumes:
      - "./data/redis:/data/redis"
    command: redis-server --save 20 1 --loglevel warning --requirepass eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
    environment:
      - REDIS_REPLICATION_MODE=master
  zookeeper: # ref: baeldung.com/ops/kafka-docker-setup
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "22181:2181"
  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
  finance-transaction-service:
    image: finance-transaction-service:latest
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - alpine:3.10.2
        - openjdk:17.0.1-jdk-slim
        - maven:3.8.7-openjdk-18-slim
    ports:
      - target: 8080
        published: 8080
    volumes:
        - "./src/main/resources/:/datadir/"
        - "${HOME}/.m2:/root/.m2"
    depends_on:
      - service-mariadb
      - service-redis
      - kafka
    environment:
      - DATABASE_URL=r2dbc:mariadb://service-mariadb:3306/finance-transactions?allowPublicKeyRetrieval=true&useSSL=false&useLegacyDatetimeCode=false
      - LIQUIBASE_DATABASE_URL=jdbc:mariadb://service-mariadb:3306/finance-transactions?allowPublicKeyRetrieval=true&useSSL=false&useLegacyDatetimeCode=false
      - DATABASE_NAME=finance-transactions
      - DATABASE_USER=transactions
      - DATABASE_PASSWORD=mauFJcuf5dhRMQrjj
      - CONNECTION_POOL_ENABLED=true
      - CONNECTION_POOL_INITIAL_SIZE=10
      - MIN_POOL_SIZE=3
      - MAX_POOL_SIZE=20
      - VALIDATION_DEPTH=local
      - VALIDATION_QUERY=SELECT 1
      - MAX_IDLE_TIME=3m
      - HASH_FUNCTION=SHA3-256
      - LOG_PATH=/var/log/
      - LOG_LEVEL=DEBUG
      - REDIS_HOST=127.0.0.1
      - REDIS_PORT=6379
      - REDIS_PASSWORD=eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
    external_links:
      - service-mysql
      - service-redis
      - localstack
    restart: on-failure
# Names our volume
volumes:
  cache:
    driver: local
  finance-transaction-service: